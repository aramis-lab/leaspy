default:
  timeout: 1 hour
  retry: 1
  interruptible: false

stages:
  - build
  - test
  - deploy

.update_conda:
  stage: .pre
  script:
    - conda init bash
    - eval "$(conda shell.bash hook)"
    - conda update --yes conda

.loop_on_python_versions:
  parallel:
    matrix:
      - PYTHON_VERSION: ['3.7', '3.8', '3.9'] # 3.10
      # TODO? also test on a virtual env with minimal version of requirements (>=X.Y.Z --> ==X.Y.Z)
  except:
    - tags

.create_conda_envs:
  stage: build
  extends: .loop_on_python_versions
  script:
    - conda --version
    # use 'create --yes' to force re-creation of env if it already exists (instead of '|| true' that just continues if env already exists)
    - conda create --yes python=$PYTHON_VERSION --name leaspy_env_${PYTHON_VERSION}_${CI_COMMIT_BRANCH} || true
    - conda activate leaspy_env_${PYTHON_VERSION}_${CI_COMMIT_BRANCH}
    - pip install -U -r requirements.txt
    - pip install -U -r requirements_dev.txt
    - conda deactivate

# only delete the created conda environment for branch when in a MR
# TODO? always delete them? (in a `after_script` section)
.remove_conda_envs:
  stage: .post
  extends: .loop_on_python_versions
  only:
    - merge_requests
  script:
    - conda env remove --yes --name leaspy_env_${PYTHON_VERSION}_${CI_COMMIT_BRANCH}

.tests:
  stage: test
  extends: .loop_on_python_versions
  retry: 0  # no retry if failed
  interruptible: true  # job should be canceled when a newer pipeline starts before the job completes
  script:
    - conda activate leaspy_env_${PYTHON_VERSION}_${CI_COMMIT_BRANCH}
    - python --version
    - pip freeze
    # Customize the title of code coverage HTML report
    - "sed -i.bak -E 's/^title = Leaspy - (.+)$/title = Leaspy :: ${CI_COMMIT_BRANCH} - \\1 (Python ${PYTHON_VERSION})/' .coveragerc"
    - pytest --cov --cov-context=test --cov-report=html:htmlcov_${PYTHON_VERSION} --cov-report=xml:coverage_${PYTHON_VERSION}.xml --cov-report=term --junitxml=tests_${PYTHON_VERSION}.xml tests/
    - conda deactivate
  coverage: '/^TOTAL(?:\s+.*){2}\s+(\d+(?:\.\d+)?\%)$/'
  artifacts:
    paths:
      # for people to browse if they want (in addition to Gitlab tool)
      - htmlcov_${PYTHON_VERSION}/
    reports:
      # these reports will be directly integrated to Gitlab (MR)
      cobertura: coverage_${PYTHON_VERSION}.xml
      junit: tests_${PYTHON_VERSION}.xml
    expire_in: 30 days

# Deploy coverage pages
pages:
  stage: deploy
  except:
    - tags
  #only:
  #  - master
  tags:
    - linux  # arbitrary choice...
  dependencies:
    - tests_linux
  script:
    - mkdir -p public/coverage/
    # Only publish the Python 3.9 HTML code coverage report
    - mv htmlcov_3.9 public/coverage/$CI_COMMIT_BRANCH
  artifacts:
    paths:
      - public/
    expire_in: 30 days

# Publish package in Gitlab Package Registry & TestPyPI (for tags only)
publish_pkg:
  stage: deploy
  only:
    - tags
  retry: 0
  script:
    - conda activate leaspy_deploy
    - conda upgrade --all --yes
    - python setup.py sdist bdist_wheel
    - envsubst < .pypirc.in > .pypirc  # substitute environment variables in template
    - python -m twine upload --verbose --config-file .pypirc --repository gitlab dist/*
    - python -m twine upload --verbose --config-file .pypirc --repository testpypi dist/*
    - conda deactivate
  tags:
    - linux  # arbitrary choice...

# Assign scripts to different CI machines
update_conda_linux:
  extends: .update_conda
  tags:
    - linux

update_conda_macos:
  extends: .update_conda
  tags:
    - macos
  except:
    - tags  # not needed for publish_pkg job (executed on linux only)

create_conda_envs_macos:
  extends: .create_conda_envs
  tags:
    - macos

create_conda_envs_linux:
  extends: .create_conda_envs
  tags:
    - linux

remove_conda_envs_macos:
  extends: .remove_conda_envs
  tags:
    - macos

remove_conda_envs_linux:
  extends: .remove_conda_envs
  tags:
    - linux

tests_macos:
  extends: .tests
  tags:
    - macos

tests_linux:
  extends: .tests
  tags:
   - linux
